@page "{id:int}"
@model AuditSentinel.Pages.Escaneos.DetailsModel
@{
    ViewData["Title"] = "Detalle del Escaneo";
}

<div class="p-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Detalle del Escaneo #@Model.Escaneo.IdEscaneo</h2>
        <div>
            <a asp-page="Edit" asp-route-id="@Model.Escaneo.IdEscaneo" class="btn btn-primary">Editar</a>
            <a asp-page="Index" class="btn btn-secondary">Volver</a>
        </div>
    </div>

    <div class="card mb-4 border-primary shadow-sm">
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-md-4">
                    <h4 class="card-title text-primary">@Model.Escaneo.NombreEscaneo</h4>
                    <p class="mb-0"><strong>Fecha:</strong> @Model.Escaneo.FechaEscaneo.ToString("dd/MM/yyyy HH:mm")</p>
                    <p><strong>Estado Actual:</strong> <span id="txtEstado" class="badge bg-info text-dark">@Model.Escaneo.Estado</span></p>
                </div>
                <div class="col-md-5">
                    <label class="fw-bold">Progreso del Escaneo en Tiempo Real:</label>
                    <div class="progress" style="height: 30px;">
                        <div id="pBar" class="progress-bar progress-bar-striped bg-success"
                             role="progressbar" style="width: 0%;">
                            0%
                        </div>
                    </div>
                </div>
                <div class="col-md-3 text-end">
                    @{
                        var primeraIp = Model.Escaneo.EscaneosServidores.FirstOrDefault()?.Servidores?.IP ?? "";
                    }
                    <div id="btnGroupEscaneo">
                        <button id="btnStart" class="btn btn-success btn-lg w-100 mb-2"
                                onclick="iniciarEscaneo('@primeraIp')" @(string.IsNullOrEmpty(primeraIp) ? "disabled" : "")>
                            <i class="bi bi-play-fill"></i> Iniciar Nmap
                        </button>

                        <button id="btnStop" class="btn btn-danger btn-lg w-100 d-none" onclick="detenerEscaneo()">
                            <i class="bi bi-stop-fill"></i> Detener Escaneo
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-4">
            <div class="card h-100 shadow-sm">
                <div class="card-header bg-light"><strong>Servidores Asociados</strong></div>
                <ul class="list-group list-group-flush">
                    @if (Model.Escaneo.EscaneosServidores.Any())
                    {
                        @foreach (var s in Model.Escaneo.EscaneosServidores)
                        {
                            <li class="list-group-item">
                                <strong>@s.Servidores.NombreServidor</strong><br />
                                <small class="text-muted">IP: @s.Servidores.IP | SO: @s.Servidores.SistemaOperativo</small>
                            </li>
                        }
                    }
                    else
                    {
                        <li class="list-group-item text-muted">No hay servidores asociados.</li>
                    }
                </ul>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card h-100 shadow-sm">
                <div class="card-header bg-light"><strong>Plantillas Aplicadas</strong></div>
                <ul class="list-group list-group-flush">
                    @if (Model.Escaneo.EscaneosPlantillas.Any())
                    {
                        @foreach (var p in Model.Escaneo.EscaneosPlantillas)
                        {
                            <li class="list-group-item">@p.Plantillas.NombrePlantilla</li>
                        }
                    }
                    else
                    {
                        <li class="list-group-item text-muted">No hay plantillas asociadas.</li>
                    }
                </ul>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card h-100 shadow-sm border-danger">
                <div class="card-header bg-dark text-white text-center"><strong>Logs de Errores Típicos</strong></div>
                <div class="table-responsive" style="max-height: 250px;">
                    <table class="table table-sm mb-0">
                        <tbody id="logTableBody">
                            <tr class="text-center"><td class="text-muted p-3">Esperando inicio...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="card mt-4 shadow-sm">
        <div class="card-body">
            <h5 class="card-title">Exportar Resultados</h5>
            <div class="btn-group" role="group">
                <a asp-page-handler="Export" asp-route-id="@Model.Escaneo.IdEscaneo" asp-route-format="pdf" class="btn btn-outline-danger">PDF</a>
                <a asp-page-handler="Export" asp-route-id="@Model.Escaneo.IdEscaneo" asp-route-format="csv" class="btn btn-outline-success">CSV</a>
                <a asp-page-handler="Export" asp-route-id="@Model.Escaneo.IdEscaneo" asp-route-format="html" class="btn btn-outline-info">HTML</a>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let pollInterval;

        async function iniciarEscaneo(ip) {
            if(!ip) return alert("No hay IP válida para escanear.");

            // UI: Cambiar botones y activar animación
            document.getElementById('btnStart').classList.add('d-none');
            document.getElementById('btnStop').classList.remove('d-none');
            document.getElementById('pBar').classList.add('progress-bar-animated');
            document.getElementById('txtEstado').innerText = "Ejecutando...";

            try {
                await fetch(`?handler=Iniciar&ip=${ip}`, {
                    method: 'POST',
                    headers: { "RequestVerificationToken": $('input[name="__RequestVerificationToken"]').val() }
                });
                pollInterval = setInterval(actualizarEstado, 2000);
            } catch (error) {
                console.error("Error al iniciar:", error);
                resetUI("Error al conectar con el servidor");
            }
        }

        async function detenerEscaneo() {
            if(!confirm("¿Estás seguro de que deseas detener el escaneo actual?")) return;

            try {
                await fetch(`?handler=Detener`, {
                    method: 'POST',
                    headers: { "RequestVerificationToken": $('input[name="__RequestVerificationToken"]').val() }
                });
                clearInterval(pollInterval);
                resetUI("Escaneo detenido por el usuario");
            } catch (error) {
                console.error("Error al detener:", error);
            }
        }

        function resetUI(mensaje) {
            document.getElementById('btnStart').classList.remove('d-none');
            document.getElementById('btnStart').disabled = false;
            document.getElementById('btnStop').classList.add('d-none');

            const bar = document.getElementById('pBar');
            bar.style.width = '0%';
            bar.innerText = '0%';
            bar.classList.remove('progress-bar-animated');

            document.getElementById('txtEstado').innerText = mensaje;
            document.getElementById('txtEstado').className = "badge bg-secondary";
        }

        async function actualizarEstado() {
            try {
                const response = await fetch('?handler=Estado');
                const data = await response.json();

                // Actualizar Barra
                const bar = document.getElementById('pBar');
                bar.style.width = data.porcentaje + '%';
                bar.innerText = data.porcentaje + '%';

                // Actualizar Tabla de Logs
                const tbody = document.getElementById('logTableBody');
                if (data.logs && data.logs.length > 0) {
                    tbody.innerHTML = data.logs.map(log => `
                        <tr class="table-danger">
                            <td class="small p-2">
                                <strong>[${log.fase}]</strong>: ${log.mensaje}<br/>
                                <small class="text-muted">Cmd: ${log.comandoEjecutado}</small>
                            </td>
                        </tr>
                    `).join('');
                }

                // Si terminó el proceso
                if (data.porcentaje >= 100) {
                    clearInterval(pollInterval);
                    bar.classList.remove('progress-bar-animated');
                    document.getElementById('btnStart').classList.remove('d-none');
                    document.getElementById('btnStop').classList.add('d-none');
                    document.getElementById('txtEstado').innerText = "Finalizado";
                    document.getElementById('txtEstado').className = "badge bg-success";
                }
            } catch (error) {
                console.error("Error al obtener estado:", error);
            }
        }
    </script>
}